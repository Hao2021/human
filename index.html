<!-- Chosen Palette: Futuristic Purple/Pink Gradient (Primary: #9B5DE0, Accent: #F15BB5) -->
<!-- Application Structure Plan: Dashboard/Chat Interface. The structure focuses on maximizing the visibility of the primary data visualization (Radar Chart) and presenting the simulation results in a dynamic, scrollable log (like a chat history). This structure was chosen to emphasize the iterative, conversational nature of the "system dialogue" and the immediate feedback loop (chart update -> detailed log entry) central to the project's goal. -->
<!-- Visualization & Content Choices:
1. System State Vector (Vitality, Cognition, Emotion, Adaptability, Meaning) -> Goal: Visualize systemic coherence/imbalance -> Viz/Presentation Method: Chart.js Radar Chart (Canvas) with two datasets for current and projected states -> Interaction: Dynamic update after Survey, Simulation, and Recommendation runs. -> Justification: Radar charts are excellent for visualizing multi-dimensional balance/imbalance. Library/Method: Chart.js (Canvas).
2. Event Input -> Goal: Personalize the simulation input -> Viz/Presentation Method: Large Textarea Input -> Interaction: Submit button triggers AI call, sending text as context. -> Justification: Captures the "real-world" context of the system disturbance. Library/Method: Vanilla JS.
3. Simulation Log -> Goal: Display AI analysis and synthesis -> Viz/Presentation Method: Scrollable, segmented log with distinct user/AI chat bubbles -> Interaction: Log entries dynamically added on button click. -> Justification: Provides in-depth, recursive feedback loops as requested by the prompt. Library/Method: Vanilla JS DOM manipulation.
4. Survey Modal -> Goal: Set initial user state (personalized start) -> Viz/Presentation Method: Sliders/Form in a Modal -> Interaction: Submitting updates the chart and closes the modal. -> Justification: Makes the simulation immediately relevant to the user. Library/Method: Vanilla JS.
5. Recommendation Logic -> Goal: Proactive system optimization -> Viz/Presentation Method: AI-generated text and a second dataset in the Radar Chart (Projected State) -> Interaction: Button click runs new AI logic and updates the chart. -> Justification: Provides immediate visual feedback on potential system improvements. Library/Method: Chart.js & Serverless Function (secure API call).
CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human Potential System Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f0f35 0%, #3d1c6e 100%);
            min-height: 100vh;
            color: #E0E0E0;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px; /* Base height for chart visibility */
            max-height: 450px;
            margin: 0 auto;
        }
        .collapsible-section {
            will-change: height, opacity, transform;
        }
        .focus-overlay {
            position: fixed;
            inset: 0;
            background: rgba(19, 11, 36, 0.55);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease;
            z-index: 50;
            backdrop-filter: blur(14px);
        }
        .focus-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        #eventInputSection {
            position: relative;
            z-index: 1;
            transition: transform 0.45s cubic-bezier(0.33, 1, 0.68, 1), box-shadow 0.45s cubic-bezier(0.33, 1, 0.68, 1), border-color 0.35s ease;
            padding: clamp(1.75rem, 2.5vw + 1rem, 2.75rem);
        }
        .modal-card {
            position: fixed !important;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.94);
            width: min(92vw, 760px);
            max-height: calc(90vh - 3rem);
            overflow-y: auto;
            border-radius: 1.5rem;
            box-shadow: 0 42px 120px rgba(16, 8, 32, 0.7);
            z-index: 80;
            opacity: 0;
            transition: transform 0.45s cubic-bezier(0.33, 1, 0.68, 1), opacity 0.35s ease;
        }
        .modal-card.modal-card-active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .modal-placeholder {
            width: 100%;
            transition: height 0.3s ease;
        }
        body.modal-open {
            overflow: hidden;
        }
        .cta-press {
            animation: ctaPress 0.45s ease;
        }
        @keyframes ctaPress {
            0% {
                transform: scale(1);
                box-shadow: 0 10px 25px rgba(155, 93, 224, 0.45);
            }
            40% {
                transform: scale(0.97);
                box-shadow: 0 6px 18px rgba(241, 91, 181, 0.35);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 10px 25px rgba(155, 93, 224, 0.45);
            }
        }
        .input-card-label {
            font-size: 0.75rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: rgba(226, 214, 255, 0.78);
            font-weight: 600;
        }
        #eventInput {
            min-height: 250px;
            font-size: 1rem;
            line-height: 1.75;
            padding: 1.2rem 1.35rem;
            resize: vertical;
            transition: box-shadow 0.35s ease, border-color 0.3s ease, background-color 0.3s ease;
        }
        #eventInput:focus {
            box-shadow: 0 28px 68px -28px rgba(241, 91, 181, 0.55);
        }
        #eventInput::placeholder {
            color: rgba(201, 189, 226, 0.6);
        }
        .action-button {
            font-size: 0.85rem;
            padding: 0.75rem 1rem;
            border-radius: 0.85rem;
            transition: background-color 0.25s ease, color 0.25s ease, transform 0.35s cubic-bezier(0.33, 1, 0.68, 1), box-shadow 0.35s cubic-bezier(0.33, 1, 0.68, 1);
            will-change: transform, box-shadow;
        }
        .action-button:hover {
            transform: translateY(-2px);
        }
        .action-button:active {
            transform: translateY(1px);
        }
        #runAiCycleBtn.action-button {
            box-shadow: 0 12px 34px -18px rgba(241, 91, 181, 0.5);
        }
        #runAiCycleBtn.action-button:hover {
            box-shadow: 0 18px 45px -18px rgba(241, 91, 181, 0.65);
        }
        #runRecommendationBtn.action-button {
            box-shadow: 0 12px 30px -20px rgba(155, 93, 224, 0.48);
        }
        #runRecommendationBtn.action-button:hover {
            box-shadow: 0 16px 38px -18px rgba(155, 93, 224, 0.58);
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
                max-width: 600px;
            }
            #eventInput {
                min-height: 320px;
                font-size: 1.05rem;
                padding: 1.35rem 1.5rem;
            }
            .action-button {
                font-size: 0.9rem;
                padding: 0.85rem 1.15rem;
            }
        }
        @media (max-width: 640px) {
            #eventInputSection {
                padding: 2.4rem 1.5rem 2.6rem;
                margin-left: -1.25rem;
                margin-right: -1.25rem;
                width: calc(100% + 2.5rem);
            }
            #eventInput {
                min-height: 320px;
                font-size: 1.05rem;
                line-height: 1.8;
            }
            .action-button {
                font-size: 0.8rem;
                padding: 0.75rem 0.9rem;
            }
            #eventInputSection .button-row {
                gap: 0.75rem;
            }
            .modal-card {
                width: min(96vw, 640px);
                max-height: calc(100vh - 2rem);
            }
        }
        .log-close-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 9999px;
            border: 1px solid rgba(241, 91, 181, 0.4);
            color: rgba(226, 214, 255, 0.85);
            background: rgba(36, 21, 58, 0.65);
            transition: background-color 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
            backdrop-filter: blur(2px);
        }
        .log-close-button:hover {
            background: rgba(241, 91, 181, 0.22);
            transform: translateY(-1px);
        }
        .log-processing {
            display: none;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            border-radius: 0.9rem;
            border: 1px solid rgba(241, 91, 181, 0.28);
            background: rgba(155, 93, 224, 0.1);
            box-shadow: inset 0 0 0 1px rgba(36, 21, 58, 0.35);
        }
        .log-processing.active {
            display: flex;
        }
        .log-spinner {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            border: 3px solid rgba(241, 91, 181, 0.3);
            border-top-color: rgba(241, 91, 181, 0.95);
            animation: spin 0.85s linear infinite;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 1;
            transition: opacity 0.4s ease;
        }
        .modal-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .modal-overlay.fade-out .modal-content {
            transform: translateY(-24px);
            opacity: 0;
        }
        .modal-content {
            background: #1f0f35;
            color: #E0E0E0;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(155, 93, 224, 0.5);
            max-height: 90vh;
            overflow-y: auto;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
        .hidden {
            display: none;
        }
        .gradient-text {
            background-image: linear-gradient(45deg, #9B5DE0, #F15BB5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #4a346e;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #F15BB5;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(241, 91, 181, 0.8);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #F15BB5;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(241, 91, 181, 0.8);
        }
    </style>
</head>
<body>

    <main class="min-h-screen flex flex-col items-center p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-extrabold mb-6 gradient-text text-center pt-4">
            Human Potential System Simulator
        </h1>
        
        <div class="w-full max-w-4xl bg-[#1a0c2c] rounded-xl shadow-2xl p-4 md:p-8 flex flex-col gap-6">

            <!-- System State Chart -->
            <div id="systemStateSection" class="collapsible-section bg-[#2a1b3d] p-4 md:p-6 rounded-xl shadow-inner border border-[#9B5DE0]/30">
                <h2 class="text-xl font-bold gradient-text mb-4 text-center">Current System State Vector</h2>
                <div class="chart-container">
                    <canvas id="systemStateChart"></canvas>
                </div>
            </div>

            <!-- Simulation Log (Chat History) -->
            <div id="simulationLogContainer" class="collapsible-section flex-grow bg-[#1f0f35] p-4 md:p-6 rounded-xl shadow-inner border border-[#F15BB5]/30 overflow-y-auto max-h-[60vh] md:max-h-[65vh] min-h-[300px]">
                <div class="flex items-center justify-between mb-4">
                    <p class="text-lg font-bold text-gray-300">Simulation Log</p>
                    <button id="closeLogModalBtn" type="button" class="log-close-button hidden" aria-label="Close simulation log view">
                        <span aria-hidden="true">âœ•</span>
                        <span class="sr-only">Close simulation log</span>
                    </button>
                </div>
                <div id="logProcessingOverlay" class="log-processing hidden" role="status" aria-live="polite">
                    <span class="log-spinner"></span>
                    <span id="logProcessingText" class="text-sm font-medium text-[#F15BB5]">Analyzing event...</span>
                </div>
                <div id="logEntries" class="space-y-4">
                    <!-- Initial Message -->
                    <div id="initialLog" class="p-3 bg-[#2a1b3d] rounded-lg border-l-4 border-[#9B5DE0]">
                        <p class="text-gray-400 italic">Welcome! Please click the 'Start Simulation' button in the popup to set your initial state.</p>
                    </div>
                </div>
            </div>

            <!-- Input and Action Controls -->
            <div id="eventInputSection" class="mt-4 p-4 bg-[#2a1b3d] rounded-xl border border-[#9B5DE0]/30">
                <h3 class="input-card-label mb-3">Describe a new event to simulate</h3>
                <textarea id="eventInput" class="w-full rounded-lg bg-[#1f0f35] text-gray-100 border border-[#9B5DE0]/50 focus:border-[#F15BB5] outline-none" rows="6" placeholder="Example: 'I received unexpected, harsh criticism at work, but later spent time in nature with my family.'"></textarea>

                <div class="button-row flex flex-col md:flex-row gap-3 md:gap-4 mt-5 items-stretch">
                    <button id="runAiCycleBtn" class="action-button flex-1 bg-[#F15BB5] text-white font-semibold rounded-lg shadow-lg shadow-[#F15BB5]/40 hover:bg-[#E04BA4] transition-colors flex items-center justify-center gap-2 disabled:opacity-75"
                    >
                        <span id="cycleBtnText">ðŸ§  Simulate Event</span>
                        <svg id="cycleLoader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <button id="runRecommendationBtn" class="action-button flex-1 bg-transparent border border-[#9B5DE0] text-[#9B5DE0] font-semibold rounded-lg shadow-lg hover:bg-[#9B5DE0] hover:text-white transition-colors flex items-center justify-center gap-2 disabled:opacity-75">
                        <span id="recommendationBtnText">ðŸ’¡ Get Recommendation</span>
                        <svg id="recommendationLoader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="inputFocusOverlay" class="focus-overlay"></div>

    <!-- Initial State Survey Modal -->
    <div id="surveyModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold gradient-text mb-4">Initialize Your System State</h2>
            <p class="text-gray-400 leading-relaxed mb-6">Set your current state (1 = Low, 10 = High) to personalize the simulation. This will be the starting point for your first AI cycle.</p>
            
            <div class="space-y-5">
                <div>
                    <label for="vitalitySlider" class="block font-semibold text-gray-200 mb-1">1. Vitality: Physical energy and health <span id="vitalityValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="vitalitySlider" type="range" min="1" max="10" value="5">
                </div>
                
                <div>
                    <label for="cognitionSlider" class="block font-semibold text-gray-200 mb-1">2. Cognition: Clarity, focus, and thinking speed <span id="cognitionValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="cognitionSlider" type="range" min="1" max="10" value="5">
                </div>

                <div>
                    <label for="emotionSlider" class="block font-semibold text-gray-200 mb-1">3. Emotion: Stability, mood, and resilience <span id="emotionValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="emotionSlider" type="range" min="1" max="10" value="5">
                </div>

                <div>
                    <label for="adaptabilitySlider" class="block font-semibold text-gray-200 mb-1">4. Adaptability: Handling change and stress <span id="adaptabilityValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="adaptabilitySlider" type="range" min="1" max="10" value="5">
                </div>

                <div>
                    <label for="meaningSlider" class="block font-semibold text-gray-200 mb-1">5. Meaning: Sense of purpose and alignment <span id="meaningValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="meaningSlider" type="range" min="1" max="10" value="5">
                </div>
            </div>

            <button id="submitSurveyBtn" class="mt-8 w-full bg-[#9B5DE0] text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-[#9B5DE0]/40 hover:bg-[#8B4FE8] transition-colors">
                Start Simulation
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const runAiCycleBtn = document.getElementById('runAiCycleBtn');
            const cycleLoader = document.getElementById('cycleLoader');
            const cycleBtnText = document.getElementById('cycleBtnText');
            const runRecommendationBtn = document.getElementById('runRecommendationBtn');
            const recommendationLoader = document.getElementById('recommendationLoader');
            const recommendationBtnText = document.getElementById('recommendationBtnText');
            const simulationLogContainer = document.getElementById('simulationLogContainer');
            const logEntries = document.getElementById('logEntries');
            const initialLog = document.getElementById('initialLog');
            const eventInput = document.getElementById('eventInput');
            const eventInputSection = document.getElementById('eventInputSection');

            const inputFocusOverlay = document.getElementById('inputFocusOverlay');
            const closeLogModalBtn = document.getElementById('closeLogModalBtn');
            const logProcessingOverlay = document.getElementById('logProcessingOverlay');
            const logProcessingText = document.getElementById('logProcessingText');

            const modalConfigs = {
                input: { element: eventInputSection, placeholder: null },
                log: { element: simulationLogContainer, placeholder: null }
            };

            const activeModalTypes = new Set();
            let preserveOverlayOnBlur = false;

            const activateOverlay = () => {
                if (inputFocusOverlay) {
                    inputFocusOverlay.classList.add('active');
                }
                document.body.classList.add('modal-open');
            };

            const deactivateOverlay = () => {
                if (inputFocusOverlay) {
                    inputFocusOverlay.classList.remove('active');
                }
                document.body.classList.remove('modal-open');
            };

            const ensurePlaceholder = (config) => {
                if (!config || !config.element) return;
                if (!config.placeholder) {
                    const placeholder = document.createElement('div');
                    placeholder.className = 'modal-placeholder';
                    config.element.parentNode.insertBefore(placeholder, config.element);
                    config.placeholder = placeholder;
                }
                config.placeholder.style.height = `${config.element.offsetHeight}px`;
            };

            const openModal = (type) => {
                const config = modalConfigs[type];
                if (!config || !config.element || config.element.classList.contains('modal-card')) {
                    return;
                }

                ensurePlaceholder(config);
                activateOverlay();

                config.element.classList.add('modal-card');
                requestAnimationFrame(() => {
                    config.element.classList.add('modal-card-active');
                });

                if (type === 'input') {
                    config.element.setAttribute('role', 'dialog');
                    config.element.setAttribute('aria-modal', 'true');
                    config.element.setAttribute('aria-label', 'Describe a new event to simulate');
                }

                activeModalTypes.add(type);
            };

            const closeModal = (type, options = {}) => {
                const { preserveOverlay = false } = options;
                const config = modalConfigs[type];
                if (!config || !config.element || !config.element.classList.contains('modal-card')) {
                    activeModalTypes.delete(type);
                    if (!preserveOverlay && activeModalTypes.size === 0) {
                        deactivateOverlay();
                    }
                    return;
                }

                const element = config.element;

                const finalize = () => {
                    element.classList.remove('modal-card');
                    element.removeEventListener('transitionend', handleTransitionEnd);
                    if (config.placeholder) {
                        config.placeholder.remove();
                        config.placeholder = null;
                    }
                    element.removeAttribute('role');
                    element.removeAttribute('aria-modal');
                    element.removeAttribute('aria-label');
                };

                const handleTransitionEnd = (event) => {
                    if (event.propertyName !== 'transform') return;
                    finalize();
                };

                element.addEventListener('transitionend', handleTransitionEnd);
                requestAnimationFrame(() => {
                    element.classList.remove('modal-card-active');
                });

                activeModalTypes.delete(type);

                if (!preserveOverlay && activeModalTypes.size === 0) {
                    deactivateOverlay();
                } else if (preserveOverlay) {
                    activateOverlay();
                }

                setTimeout(finalize, 520);
            };

            const openLogModal = (statusText = 'Analyzing event...') => {
                if (logProcessingOverlay) {
                    logProcessingOverlay.classList.remove('hidden');
                    logProcessingOverlay.classList.add('active');
                }
                if (logProcessingText && statusText) {
                    logProcessingText.textContent = statusText;
                }
                openModal('log');
                simulationLogContainer.setAttribute('role', 'dialog');
                simulationLogContainer.setAttribute('aria-modal', 'true');
                simulationLogContainer.setAttribute('aria-label', 'Simulation log results');
                simulationLogContainer.scrollTop = simulationLogContainer.scrollHeight;
                if (closeLogModalBtn) {
                    closeLogModalBtn.classList.remove('hidden');
                }
            };

            const hideLogProcessing = () => {
                if (!logProcessingOverlay) return;
                logProcessingOverlay.classList.remove('active');
                setTimeout(() => {
                    if (!logProcessingOverlay.classList.contains('active')) {
                        logProcessingOverlay.classList.add('hidden');
                    }
                }, 220);
            };

            const closeLogModal = () => {
                hideLogProcessing();
                simulationLogContainer.removeAttribute('role');
                simulationLogContainer.removeAttribute('aria-modal');
                simulationLogContainer.removeAttribute('aria-label');
                if (closeLogModalBtn) {
                    closeLogModalBtn.classList.add('hidden');
                }
                closeModal('log');
            };

            eventInput.addEventListener('focus', () => {
                openModal('input');
            });

            eventInput.addEventListener('blur', () => {
                if (modalConfigs.input.element.classList.contains('modal-card')) {
                    closeModal('input', { preserveOverlay: preserveOverlayOnBlur });
                }
                preserveOverlayOnBlur = false;
            });

            if (inputFocusOverlay) {
                inputFocusOverlay.addEventListener('click', () => {
                    if (activeModalTypes.has('log')) {
                        closeLogModal();
                    } else if (activeModalTypes.has('input')) {
                        eventInput.blur();
                    }
                });
            }

            if (closeLogModalBtn) {
                closeLogModalBtn.addEventListener('click', () => {
                    closeLogModal();
                });
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (activeModalTypes.has('log')) {
                        closeLogModal();
                    } else if (document.activeElement === eventInput) {
                        eventInput.blur();
                    }
                }
            });

            const surveyModal = document.getElementById('surveyModal');
            const submitSurveyBtn = document.getElementById('submitSurveyBtn');
            const sliders = {
                vitality: document.getElementById('vitalitySlider'),
                cognition: document.getElementById('cognitionSlider'),
                emotion: document.getElementById('emotionSlider'),
                adaptability: document.getElementById('adaptabilitySlider'),
                meaning: document.getElementById('meaningSlider')
            };
            const values = {
                vitality: document.getElementById('vitalityValue'),
                cognition: document.getElementById('cognitionValue'),
                emotion: document.getElementById('emotionValue'),
                adaptability: document.getElementById('adaptabilityValue'),
                meaning: document.getElementById('meaningValue')
            };

            Object.keys(sliders).forEach(key => {
                sliders[key].addEventListener('input', (e) => {
                    values[key].textContent = e.target.value;
                });
            });

            submitSurveyBtn.addEventListener('click', () => {
                submitSurveyBtn.classList.add('cta-press');
                setTimeout(() => submitSurveyBtn.classList.remove('cta-press'), 450);

                const newData = [
                    parseInt(sliders.vitality.value, 10),
                    parseInt(sliders.cognition.value, 10),
                    parseInt(sliders.emotion.value, 10),
                    parseInt(sliders.adaptability.value, 10),
                    parseInt(sliders.meaning.value, 10)
                ];

                systemChart.data.datasets[0].data = newData;
                systemChart.data.datasets[1].data = newData;
                systemChart.data.datasets[1].hidden = true;
                systemChart.update();

                surveyModal.classList.add('fade-out');
                surveyModal.setAttribute('aria-hidden', 'true');
                setTimeout(() => {
                    surveyModal.classList.add('hidden');
                    surveyModal.classList.remove('fade-out');
                }, 420);

                initialLog.classList.remove('hidden');
                initialLog.innerHTML = `<p class="text-gray-400 italic">Initial state set. Describe an event and click 'Simulate Event' to begin the dynamic dialogue.</p>`;
            });



            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // --- API Configuration: Calls local serverless function endpoints ---
            // The hosting platform (Vercel/Netlify) routes these paths securely.
            const SIMULATE_ENDPOINT = '/api/simulate';
            const RECOMMEND_ENDPOINT = '/api/simulate'; 
            // We use the same file (simulate.js) for both, differentiated by the 'type' in the payload.
            
            async function callApi(endpoint, payload, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            // Check if the serverless function returned an error JSON
                            const errorBody = await response.json().catch(() => ({ message: 'Server error with no JSON body.' }));
                            throw new Error(`API request failed with status ${response.status}: ${errorBody.message || JSON.stringify(errorBody)}`);
                        }

                        return await response.json();
                        
                    } catch (error) {
                        if (i === retries - 1) {
                            console.error('API call failed after retries:', error);
                            throw error;
                        }
                        await sleep(delay * Math.pow(2, i));
                    }
                }
            }


            function escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/[&<>"']/g, function(m) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[m];
                });
            }

            // --- Chart Initialization ---
            const ctx = document.getElementById('systemStateChart').getContext('2d');
            let systemStateData = [5, 5, 5, 5, 5];
            
            const chartConfig = {
                type: 'radar',
                data: {
                    labels: ['Meaning', 'Vitality', 'Cognition', 'Emotion', 'Adaptability'],
                    datasets: [{
                        label: 'System State',
                        data: systemStateData,
                        fill: true,
                        backgroundColor: 'rgba(155, 93, 224, 0.2)',
                        borderColor: 'rgb(155, 93, 224)',
                        pointBackgroundColor: 'rgb(155, 93, 224)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(155, 93, 224)'
                    }, {
                        label: 'Projected State',
                        data: systemStateData,
                        fill: true,
                        backgroundColor: 'rgba(241, 91, 181, 0.2)',
                        borderColor: 'rgb(241, 91, 181)',
                        pointBackgroundColor: 'rgb(241, 91, 181)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(241, 91, 181)',
                        hidden: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                color: '#4a346e'
                            },
                            grid: {
                                color: '#4a346e'
                            },
                            pointLabels: {
                                font: {
                                    size: 14
                                },
                                color: '#F0F0F0'
                            },
                            suggestedMin: 0,
                            suggestedMax: 10,
                            ticks: {
                                display: false,
                                color: '#9B5DE0',
                                backdropColor: '#1a0c2c'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#F0F0F0',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            };

            const systemChart = new Chart(ctx, chartConfig);
            // --- End Chart Initialization ---

            // --- Event Handlers ---
            runAiCycleBtn.addEventListener('click', async () => {
                const eventText = eventInput.value.trim();
                if (!eventText) {
                    alert('Please describe an event before running the simulation.');
                    return;
                }

                preserveOverlayOnBlur = true;
                eventInput.blur();
                openLogModal('Analyzing event...');

                runAiCycleBtn.disabled = true;
                cycleLoader.classList.remove('hidden');
                cycleBtnText.textContent = 'Simulating...';
                initialLog.classList.add('hidden');
                
                // User input log entry
                const userEntry = document.createElement('div');
                userEntry.className = 'p-3 bg-[#4a346e] rounded-lg border-r-4 border-[#F15BB5] text-gray-200';
                userEntry.innerHTML = `<p class="font-semibold text-[#F15BB5] mb-1">Your Event:</p><p>${escapeHTML(eventText)}</p>`;
                logEntries.appendChild(userEntry);

                // AI log placeholder
                const aiEntry = document.createElement('div');
                aiEntry.className = 'p-3 bg-[#2a1b3d] rounded-lg border-l-4 border-[#9B5DE0]';
                aiEntry.innerHTML = `<p class="font-semibold text-[#9B5DE0] mb-2">System Response:</p><div class="space-y-1 text-sm text-gray-400 italic">Analyzing event across 11 subsystems...</div>`;
                logEntries.appendChild(aiEntry);

                simulationLogContainer.scrollTop = simulationLogContainer.scrollHeight;

                const currentData = systemChart.data.datasets[0].data;
                const currentState = {
                    meaning: currentData[0],
                    vitality: currentData[1],
                    cognition: currentData[2],
                    emotion: currentData[3],
                    adaptability: currentData[4]
                };
                
                const payload = { eventText, currentState, type: 'simulate' };

                try {
                    const result = await callApi(SIMULATE_ENDPOINT, payload);
                    const { analysis, conclusionSynthesis, newState } = result;

                    // 1. Format the 11-Point Analysis
                    let analysisHtml = `<p class="font-semibold text-[#9B5DE0] mb-2">System Response:</p><ul class="list-disc list-inside space-y-2 mb-4 text-gray-300">`;
                    
                    Object.keys(analysis).forEach(agent => {
                        // Dynamically assign titles (e.g., Geneticist)
                        analysisHtml += `<li class="text-sm"><strong class="text-[#F15BB5]">${agent.replace(/([A-Z])/g, ' $1').trim()}:</strong> ${escapeHTML(analysis[agent])}</li>`;
                    });
                    
                    analysisHtml += `</ul>`;

                    // 2. Add the Conclusion/Synthesis
                    analysisHtml += `<div class="mt-4 pt-3 border-t border-[#4a346e]"><p class="font-bold text-[#F15BB5] mb-1">Conclusion & Synthesis:</p><p class="text-gray-200 text-sm">${escapeHTML(conclusionSynthesis)}</p></div>`;
                    
                    aiEntry.innerHTML = analysisHtml;

                    // 3. Update the Chart
                    const newData = [
                        Math.max(1, Math.min(10, newState.meaning)),
                        Math.max(1, Math.min(10, newState.vitality)),
                        Math.max(1, Math.min(10, newState.cognition)),
                        Math.max(1, Math.min(10, newState.emotion)),
                        Math.max(1, Math.min(10, newState.adaptability))
                    ];
                    
                    systemChart.data.datasets[0].data = newData;
                    systemChart.data.datasets[1].data = newData;
                    systemChart.data.datasets[1].hidden = true; // Hide projected state after event simulation
                    systemChart.update();

                } catch (error) {
                    aiEntry.innerHTML = `<p class="font-semibold text-red-500">Simulation Error</p><p>Could not contact the AI simulation network. (Details: ${escapeHTML(error.message)})</p>`;
                } finally {
                    runAiCycleBtn.disabled = false;
                    cycleLoader.classList.add('hidden');
                    cycleBtnText.textContent = 'ðŸ§  Simulate Event';
                    eventInput.value = ''; // Clear input after simulation
                    hideLogProcessing();
                    simulationLogContainer.scrollTop = simulationLogContainer.scrollHeight;
                }
            });

            runRecommendationBtn.addEventListener('click', async () => {
                openLogModal('Preparing recommendation...');

                runRecommendationBtn.disabled = true;
                recommendationLoader.classList.remove('hidden');
                recommendationBtnText.textContent = 'Analyzing...';
                initialLog.classList.add('hidden');

                const aiEntry = document.createElement('div');
                aiEntry.className = 'p-3 bg-[#2a1b3d] rounded-lg border-l-4 border-[#9B5DE0]';
                aiEntry.innerHTML = `<p class="font-semibold text-[#9B5DE0] mb-2">System Recommendation:</p><div class="space-y-1 text-sm text-gray-400 italic">Analyzing current state for optimization...</div>`;
                logEntries.appendChild(aiEntry);

                simulationLogContainer.scrollTop = simulationLogContainer.scrollHeight;
                
                const currentData = systemChart.data.datasets[0].data;
                const currentState = {
                    meaning: currentData[0],
                    vitality: currentData[1],
                    cognition: currentData[2],
                    emotion: currentData[3],
                    adaptability: currentData[4]
                };
                
                const payload = { currentState, type: 'recommend' };

                try {
                    const result = await callApi(RECOMMEND_ENDPOINT, payload);
                    const { recommendation, newState } = result;

                    let recommendationHtml = `<p class="font-semibold text-[#9B5DE0] mb-2">System Recommendation:</p><p class="text-gray-300 mb-4">${escapeHTML(recommendation)}</p><p class="text-xs italic text-[#F15BB5]">Chart shows projected state if this recommendation is implemented.</p>`;
                    aiEntry.innerHTML = recommendationHtml;
                    
                    const newData = [
                        Math.max(1, Math.min(10, newState.meaning)),
                        Math.max(1, Math.min(10, newState.vitality)),
                        Math.max(1, Math.min(10, newState.cognition)),
                        Math.max(1, Math.min(10, newState.emotion)),
                        Math.max(1, Math.min(10, newState.adaptability))
                    ];
                    
                    // Update Projected State Dataset
                    systemChart.data.datasets[1].data = newData;
                    systemChart.data.datasets[1].hidden = false;
                    systemChart.update();

                } catch (error) {
                    aiEntry.innerHTML = `<p class="font-semibold text-red-500">Recommendation Error</p><p>Could not contact the AI simulation network. (Details: ${escapeHTML(error.message)})</p>`;
                } finally {
                    runRecommendationBtn.disabled = false;
                    recommendationLoader.classList.add('hidden');
                    recommendationBtnText.textContent = 'ðŸ’¡ Get Recommendation';
                    hideLogProcessing();
                    simulationLogContainer.scrollTop = simulationLogContainer.scrollHeight;
                }
            });

        });
    </script>
</body>
</html>