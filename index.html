<!-- Chosen Palette: Futuristic Purple/Pink Gradient (Primary: #9B5DE0, Accent: #F15BB5) -->
<!-- Application Structure Plan: Dashboard/Chat Interface. The structure focuses on maximizing the visibility of the primary data visualization (Radar Chart) and presenting the simulation results in a dynamic, scrollable log (like a chat history). This structure was chosen to emphasize the iterative, conversational nature of the "system dialogue" and the immediate feedback loop (chart update -> detailed log entry) central to the project's goal. -->
<!-- Visualization & Content Choices:
1. System State Vector (Vitality, Cognition, Emotion, Adaptability, Meaning) -> Goal: Visualize systemic coherence/imbalance -> Viz/Presentation Method: Chart.js Radar Chart (Canvas) with two datasets for current and projected states -> Interaction: Dynamic update after Survey, Simulation, and Recommendation runs. -> Justification: Radar charts are excellent for visualizing multi-dimensional balance/imbalance. Library/Method: Chart.js (Canvas).
2. Event Input -> Goal: Personalize the simulation input -> Viz/Presentation Method: Large Textarea Input -> Interaction: Submit button triggers AI call, sending text as context. -> Justification: Captures the "real-world" context of the system disturbance. Library/Method: Vanilla JS.
3. Simulation Log -> Goal: Display AI analysis and synthesis -> Viz/Presentation Method: Scrollable, segmented log with distinct user/AI chat bubbles -> Interaction: Log entries dynamically added on button click. -> Justification: Provides in-depth, recursive feedback loops as requested by the prompt. Library/Method: Vanilla JS DOM manipulation.
4. Survey Modal -> Goal: Set initial user state (personalized start) -> Viz/Presentation Method: Sliders/Form in a Modal -> Interaction: Submitting updates the chart and closes the modal. -> Justification: Makes the simulation immediately relevant to the user. Library/Method: Vanilla JS.
5. Recommendation Logic -> Goal: Proactive system optimization -> Viz/Presentation Method: AI-generated text and a second dataset in the Radar Chart (Projected State) -> Interaction: Button click runs new AI logic and updates the chart. -> Justification: Provides immediate visual feedback on potential system improvements. Library/Method: Chart.js & Serverless Function (secure API call).
CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human Potential System Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1f0f35 0%, #3d1c6e 100%);
            min-height: 100vh;
            color: #E0E0E0;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px; /* Base height for chart visibility */
            max-height: 450px;
            margin: 0 auto;
        }
        .collapsible-section {
            will-change: height, opacity, transform;
        }
        .focus-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 9, 26, 0.65);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 30;
            backdrop-filter: blur(2px);
        }
        .focus-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        #eventInputSection {
            transition: transform 0.35s ease, box-shadow 0.35s ease, border-color 0.35s ease;
        }
        #eventInputSection.focused-card {
            transform: translateY(-6px);
            box-shadow: 0 25px 60px -20px rgba(241, 91, 181, 0.65);
            border-color: rgba(241, 91, 181, 0.75) !important;
        }
        .cta-press {
            animation: ctaPress 0.45s ease;
        }
        @keyframes ctaPress {
            0% {
                transform: scale(1);
                box-shadow: 0 10px 25px rgba(155, 93, 224, 0.45);
            }
            40% {
                transform: scale(0.97);
                box-shadow: 0 6px 18px rgba(241, 91, 181, 0.35);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 10px 25px rgba(155, 93, 224, 0.45);
            }
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
                max-width: 600px;
            }
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 1;
            transition: opacity 0.4s ease;
        }
        .modal-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        .modal-overlay.fade-out .modal-content {
            transform: translateY(-24px);
            opacity: 0;
        }
        .modal-content {
            background: #1f0f35;
            color: #E0E0E0;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(155, 93, 224, 0.5);
            max-height: 90vh;
            overflow-y: auto;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
        .hidden {
            display: none;
        }
        .gradient-text {
            background-image: linear-gradient(45deg, #9B5DE0, #F15BB5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #4a346e;
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #F15BB5;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(241, 91, 181, 0.8);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #F15BB5;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(241, 91, 181, 0.8);
        }
    </style>
</head>
<body>

    <main class="min-h-screen flex flex-col items-center p-4 md:p-8">
        <h1 class="text-3xl md:text-4xl font-extrabold mb-6 gradient-text text-center pt-4">
            Human Potential System Simulator
        </h1>
        
        <div class="w-full max-w-4xl bg-[#1a0c2c] rounded-xl shadow-2xl p-4 md:p-8 flex flex-col gap-6">

            <!-- System State Chart -->
            <div id="systemStateSection" class="collapsible-section bg-[#2a1b3d] p-4 md:p-6 rounded-xl shadow-inner border border-[#9B5DE0]/30">
                <h2 class="text-xl font-bold gradient-text mb-4 text-center">Current System State Vector</h2>
                <div class="chart-container">
                    <canvas id="systemStateChart"></canvas>
                </div>
            </div>

            <!-- Simulation Log (Chat History) -->
            <div id="simulationLogContainer" class="collapsible-section flex-grow bg-[#1f0f35] p-4 md:p-6 rounded-xl shadow-inner border border-[#F15BB5]/30 overflow-y-auto max-h-[60vh] md:max-h-[65vh] min-h-[300px]">
                <p class="text-lg font-bold text-gray-300 mb-4">Simulation Log</p>
                <div id="logEntries" class="space-y-4">
                    <!-- Initial Message -->
                    <div id="initialLog" class="p-3 bg-[#2a1b3d] rounded-lg border-l-4 border-[#9B5DE0]">
                        <p class="text-gray-400 italic">Welcome! Please click the 'Start Simulation' button in the popup to set your initial state.</p>
                    </div>
                </div>
            </div>

            <!-- Input and Action Controls -->
            <div id="eventInputSection" class="mt-4 p-4 bg-[#2a1b3d] rounded-xl border border-[#9B5DE0]/30">
                <h3 class="text-xl font-semibold text-gray-200 mb-4">Describe a new event to simulate:</h3>
                <textarea id="eventInput" class="w-full p-3 rounded-lg bg-[#1f0f35] text-gray-200 border border-[#9B5DE0]/50 focus:border-[#F15BB5] outline-none transition-colors" rows="3" placeholder="Example: 'I received unexpected, harsh criticism at work, but later spent time in nature with my family.'"></textarea>
                
                <div class="flex flex-col md:flex-row gap-4 mt-4">
                    <button id="runAiCycleBtn" class="flex-1 bg-[#F15BB5] text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-[#F15BB5]/40 hover:bg-[#E04BA4] transition-colors flex items-center justify-center gap-2 disabled:opacity-75"
                    >
                        <span id="cycleBtnText">ðŸ§  Simulate Event</span>
                        <svg id="cycleLoader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                    <button id="runRecommendationBtn" class="flex-1 bg-transparent border border-[#9B5DE0] text-[#9B5DE0] font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-[#9B5DE0] hover:text-white transition-colors flex items-center justify-center gap-2 disabled:opacity-75">
                        <span id="recommendationBtnText">ðŸ’¡ Get Recommendation</span>
                        <svg id="recommendationLoader" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="inputFocusOverlay" class="focus-overlay"></div>

    <!-- Initial State Survey Modal -->
    <div id="surveyModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="text-3xl font-bold gradient-text mb-4">Initialize Your System State</h2>
            <p class="text-gray-400 leading-relaxed mb-6">Set your current state (1 = Low, 10 = High) to personalize the simulation. This will be the starting point for your first AI cycle.</p>
            
            <div class="space-y-5">
                <div>
                    <label for="vitalitySlider" class="block font-semibold text-gray-200 mb-1">1. Vitality: Physical energy and health <span id="vitalityValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="vitalitySlider" type="range" min="1" max="10" value="5">
                </div>
                
                <div>
                    <label for="cognitionSlider" class="block font-semibold text-gray-200 mb-1">2. Cognition: Clarity, focus, and thinking speed <span id="cognitionValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="cognitionSlider" type="range" min="1" max="10" value="5">
                </div>

                <div>
                    <label for="emotionSlider" class="block font-semibold text-gray-200 mb-1">3. Emotion: Stability, mood, and resilience <span id="emotionValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="emotionSlider" type="range" min="1" max="10" value="5">
                </div>

                <div>
                    <label for="adaptabilitySlider" class="block font-semibold text-gray-200 mb-1">4. Adaptability: Handling change and stress <span id="adaptabilityValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="adaptabilitySlider" type="range" min="1" max="10" value="5">
                </div>

                <div>
                    <label for="meaningSlider" class="block font-semibold text-gray-200 mb-1">5. Meaning: Sense of purpose and alignment <span id="meaningValue" class="font-bold text-[#F15BB5]">5</span></label>
                    <input id="meaningSlider" type="range" min="1" max="10" value="5">
                </div>
            </div>

            <button id="submitSurveyBtn" class="mt-8 w-full bg-[#9B5DE0] text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-[#9B5DE0]/40 hover:bg-[#8B4FE8] transition-colors">
                Start Simulation
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const runAiCycleBtn = document.getElementById('runAiCycleBtn');
            const cycleLoader = document.getElementById('cycleLoader');
            const cycleBtnText = document.getElementById('cycleBtnText');
            const runRecommendationBtn = document.getElementById('runRecommendationBtn');
            const recommendationLoader = document.getElementById('recommendationLoader');
            const recommendationBtnText = document.getElementById('recommendationBtnText');
            const simulationLogContainer = document.getElementById('simulationLogContainer');
            const logEntries = document.getElementById('logEntries');
            const initialLog = document.getElementById('initialLog');
            const eventInput = document.getElementById('eventInput');
            const systemStateSection = document.getElementById('systemStateSection');
            const eventInputSection = document.getElementById('eventInputSection');

            const collapsibleSections = [systemStateSection, simulationLogContainer].filter(Boolean);
            collapsibleSections.forEach(section => {
                section.dataset.state = 'expanded';
                section.dataset.animating = 'false';
                section.setAttribute('aria-hidden', 'false');
            });
            let visibilityLockActive = false;
            let visibilityLockTimeout = null;

            const collapseSection = (section) => {
                if (!section || section.dataset.animating === 'true' || section.dataset.state === 'collapsed') return;

                section.dataset.animating = 'true';
                section.dataset.state = 'collapsing';
                section.setAttribute('aria-hidden', 'true');

                const startHeight = section.scrollHeight;
                section.style.transition = 'none';
                section.style.height = `${startHeight}px`;
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
                section.offsetHeight;

                section.style.transition = 'height 0.35s ease, opacity 0.35s ease, transform 0.35s ease';
                section.style.height = '0px';
                section.style.opacity = '0';
                section.style.transform = 'translateY(-12px)';

                let collapseFallback;
                const handleTransitionEnd = (event) => {
                    if (event.propertyName !== 'height') return;
                    clearTimeout(collapseFallback);
                    section.style.display = 'none';
                    section.style.height = '';
                    section.style.opacity = '';
                    section.style.transform = '';
                    section.style.transition = '';
                    section.classList.add('hidden');
                    section.dataset.state = 'collapsed';
                    section.dataset.animating = 'false';
                    section.removeEventListener('transitionend', handleTransitionEnd);
                };

                collapseFallback = setTimeout(() => {
                    handleTransitionEnd({ propertyName: 'height' });
                }, 500);

                section.addEventListener('transitionend', handleTransitionEnd);
            };

            const expandSection = (section) => {
                if (!section || section.dataset.animating === 'true' || section.dataset.state === 'expanded') return;

                section.dataset.animating = 'true';
                section.dataset.state = 'expanding';
                section.classList.remove('hidden');
                section.style.display = 'block';

                const targetHeight = section.scrollHeight || 1;

                section.style.transition = 'none';
                section.style.height = '0px';
                section.style.opacity = '0';
                section.style.transform = 'translateY(12px)';
                section.offsetHeight;

                section.style.transition = 'height 0.4s ease, opacity 0.4s ease, transform 0.4s ease';
                section.style.height = `${targetHeight}px`;
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';

                let expandFallback;
                const handleTransitionEnd = (event) => {
                    if (event.propertyName !== 'height') return;
                    clearTimeout(expandFallback);
                    section.style.display = '';
                    section.style.height = '';
                    section.style.opacity = '';
                    section.style.transform = '';
                    section.style.transition = '';
                    section.dataset.state = 'expanded';
                    section.dataset.animating = 'false';
                    section.setAttribute('aria-hidden', 'false');
                    section.removeEventListener('transitionend', handleTransitionEnd);
                };

                expandFallback = setTimeout(() => {
                    handleTransitionEnd({ propertyName: 'height' });
                }, 550);

                section.addEventListener('transitionend', handleTransitionEnd);
            };

            const showCollapsibleSections = () => {
                collapsibleSections.forEach(expandSection);
            };

            const hideCollapsibleSections = () => {
                collapsibleSections.forEach(collapseSection);
            };

            const inputFocusOverlay = document.getElementById('inputFocusOverlay');

            const enterInputFocusMode = () => {
                if (inputFocusOverlay) {
                    inputFocusOverlay.classList.add('active');
                }
                if (eventInputSection) {
                    eventInputSection.classList.add('focused-card');
                }
            };

            const leaveInputFocusMode = () => {
                if (inputFocusOverlay) {
                    inputFocusOverlay.classList.remove('active');
                }
                if (eventInputSection) {
                    eventInputSection.classList.remove('focused-card');
                }
            };

            const isEventInputProminent = () => {
                if (!eventInputSection) return false;
                const rect = eventInputSection.getBoundingClientRect();
                const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                return rect.top < viewportHeight * 0.6;
            };

            const updateSectionVisibility = () => {
                if (visibilityLockActive) return;
                if (isEventInputProminent()) {
                    hideCollapsibleSections();
                } else {
                    showCollapsibleSections();
                }
            };

            const temporarilyShowSections = (duration = 1200) => {
                leaveInputFocusMode();
                showCollapsibleSections();
                visibilityLockActive = true;
                if (visibilityLockTimeout) {
                    clearTimeout(visibilityLockTimeout);
                }
                visibilityLockTimeout = setTimeout(() => {
                    visibilityLockActive = false;
                    visibilityLockTimeout = null;
                    updateSectionVisibility();
                }, duration);
            };

            window.addEventListener('scroll', updateSectionVisibility, { passive: true });
            window.addEventListener('resize', updateSectionVisibility);

            eventInput.addEventListener('focus', () => {
                if (visibilityLockTimeout) {
                    clearTimeout(visibilityLockTimeout);
                    visibilityLockTimeout = null;
                }
                visibilityLockActive = false;
                enterInputFocusMode();
                hideCollapsibleSections();
                if (eventInputSection) {
                    requestAnimationFrame(() => {
                        eventInputSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                }
            });

            eventInput.addEventListener('blur', () => {
                leaveInputFocusMode();
                if (!visibilityLockActive) {
                    temporarilyShowSections(900);
                }
            });

            if (inputFocusOverlay) {
                inputFocusOverlay.addEventListener('click', () => {
                    temporarilyShowSections(900);
                    eventInput.blur();
                });
            }

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && document.activeElement === eventInput) {
                    temporarilyShowSections(900);
                    eventInput.blur();
                }
            });

            showCollapsibleSections();
            requestAnimationFrame(updateSectionVisibility);

            const surveyModal = document.getElementById('surveyModal');
            const submitSurveyBtn = document.getElementById('submitSurveyBtn');
            const sliders = {
                vitality: document.getElementById('vitalitySlider'),
                cognition: document.getElementById('cognitionSlider'),
                emotion: document.getElementById('emotionSlider'),
                adaptability: document.getElementById('adaptabilitySlider'),
                meaning: document.getElementById('meaningSlider')
            };
            const values = {
                vitality: document.getElementById('vitalityValue'),
                cognition: document.getElementById('cognitionValue'),
                emotion: document.getElementById('emotionValue'),
                adaptability: document.getElementById('adaptabilityValue'),
                meaning: document.getElementById('meaningValue')
            };

            Object.keys(sliders).forEach(key => {
                sliders[key].addEventListener('input', (e) => {
                    values[key].textContent = e.target.value;
                });
            });

            submitSurveyBtn.addEventListener('click', () => {
                submitSurveyBtn.classList.add('cta-press');
                setTimeout(() => submitSurveyBtn.classList.remove('cta-press'), 450);

                const newData = [
                    parseInt(sliders.vitality.value, 10),
                    parseInt(sliders.cognition.value, 10),
                    parseInt(sliders.emotion.value, 10),
                    parseInt(sliders.adaptability.value, 10),
                    parseInt(sliders.meaning.value, 10)
                ];

                systemChart.data.datasets[0].data = newData;
                systemChart.data.datasets[1].data = newData;
                systemChart.data.datasets[1].hidden = true;
                systemChart.update();

                surveyModal.classList.add('fade-out');
                surveyModal.setAttribute('aria-hidden', 'true');
                setTimeout(() => {
                    surveyModal.classList.add('hidden');
                    surveyModal.classList.remove('fade-out');
                }, 420);

                initialLog.classList.remove('hidden');
                initialLog.innerHTML = `<p class="text-gray-400 italic">Initial state set. Describe an event and click 'Simulate Event' to begin the dynamic dialogue.</p>`;
            });



            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // --- API Configuration: Calls local serverless function endpoints ---
            // The hosting platform (Vercel/Netlify) routes these paths securely.
            const SIMULATE_ENDPOINT = '/api/simulate';
            const RECOMMEND_ENDPOINT = '/api/simulate'; 
            // We use the same file (simulate.js) for both, differentiated by the 'type' in the payload.
            
            async function callApi(endpoint, payload, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            // Check if the serverless function returned an error JSON
                            const errorBody = await response.json().catch(() => ({ message: 'Server error with no JSON body.' }));
                            throw new Error(`API request failed with status ${response.status}: ${errorBody.message || JSON.stringify(errorBody)}`);
                        }

                        return await response.json();
                        
                    } catch (error) {
                        if (i === retries - 1) {
                            console.error('API call failed after retries:', error);
                            throw error;
                        }
                        await sleep(delay * Math.pow(2, i));
                    }
                }
            }


            function escapeHTML(str) {
                if (typeof str !== 'string') return '';
                return str.replace(/[&<>"']/g, function(m) {
                    return {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;'
                    }[m];
                });
            }

            // --- Chart Initialization ---
            const ctx = document.getElementById('systemStateChart').getContext('2d');
            let systemStateData = [5, 5, 5, 5, 5];
            
            const chartConfig = {
                type: 'radar',
                data: {
                    labels: ['Meaning', 'Vitality', 'Cognition', 'Emotion', 'Adaptability'],
                    datasets: [{
                        label: 'System State',
                        data: systemStateData,
                        fill: true,
                        backgroundColor: 'rgba(155, 93, 224, 0.2)',
                        borderColor: 'rgb(155, 93, 224)',
                        pointBackgroundColor: 'rgb(155, 93, 224)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(155, 93, 224)'
                    }, {
                        label: 'Projected State',
                        data: systemStateData,
                        fill: true,
                        backgroundColor: 'rgba(241, 91, 181, 0.2)',
                        borderColor: 'rgb(241, 91, 181)',
                        pointBackgroundColor: 'rgb(241, 91, 181)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(241, 91, 181)',
                        hidden: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                color: '#4a346e'
                            },
                            grid: {
                                color: '#4a346e'
                            },
                            pointLabels: {
                                font: {
                                    size: 14
                                },
                                color: '#F0F0F0'
                            },
                            suggestedMin: 0,
                            suggestedMax: 10,
                            ticks: {
                                display: false,
                                color: '#9B5DE0',
                                backdropColor: '#1a0c2c'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#F0F0F0',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            };

            const systemChart = new Chart(ctx, chartConfig);
            // --- End Chart Initialization ---

            // --- Event Handlers ---
            runAiCycleBtn.addEventListener('click', async () => {
                const eventText = eventInput.value.trim();
                if (!eventText) {
                    alert('Please describe an event before running the simulation.');
                    return;
                }

                temporarilyShowSections();
                eventInput.blur();
                window.scrollTo({ top: 0, behavior: 'smooth' });

                runAiCycleBtn.disabled = true;
                cycleLoader.classList.remove('hidden');
                cycleBtnText.textContent = 'Simulating...';
                initialLog.classList.add('hidden');
                
                // User input log entry
                const userEntry = document.createElement('div');
                userEntry.className = 'p-3 bg-[#4a346e] rounded-lg border-r-4 border-[#F15BB5] text-gray-200';
                userEntry.innerHTML = `<p class="font-semibold text-[#F15BB5] mb-1">Your Event:</p><p>${escapeHTML(eventText)}</p>`;
                logEntries.appendChild(userEntry);

                // AI log placeholder
                const aiEntry = document.createElement('div');
                aiEntry.className = 'p-3 bg-[#2a1b3d] rounded-lg border-l-4 border-[#9B5DE0]';
                aiEntry.innerHTML = `<p class="font-semibold text-[#9B5DE0] mb-2">System Response:</p><div class="space-y-1 text-sm text-gray-400 italic">Analyzing event across 11 subsystems...</div>`;
                logEntries.appendChild(aiEntry);

                simulationLogContainer.scrollTop = simulationLogContainer.scrollHeight;

                const currentData = systemChart.data.datasets[0].data;
                const currentState = {
                    meaning: currentData[0],
                    vitality: currentData[1],
                    cognition: currentData[2],
                    emotion: currentData[3],
                    adaptability: currentData[4]
                };
                
                const payload = { eventText, currentState, type: 'simulate' };

                try {
                    const result = await callApi(SIMULATE_ENDPOINT, payload);
                    const { analysis, conclusionSynthesis, newState } = result;

                    // 1. Format the 11-Point Analysis
                    let analysisHtml = `<p class="font-semibold text-[#9B5DE0] mb-2">System Response:</p><ul class="list-disc list-inside space-y-2 mb-4 text-gray-300">`;
                    
                    Object.keys(analysis).forEach(agent => {
                        // Dynamically assign titles (e.g., Geneticist)
                        analysisHtml += `<li class="text-sm"><strong class="text-[#F15BB5]">${agent.replace(/([A-Z])/g, ' $1').trim()}:</strong> ${escapeHTML(analysis[agent])}</li>`;
                    });
                    
                    analysisHtml += `</ul>`;

                    // 2. Add the Conclusion/Synthesis
                    analysisHtml += `<div class="mt-4 pt-3 border-t border-[#4a346e]"><p class="font-bold text-[#F15BB5] mb-1">Conclusion & Synthesis:</p><p class="text-gray-200 text-sm">${escapeHTML(conclusionSynthesis)}</p></div>`;
                    
                    aiEntry.innerHTML = analysisHtml;

                    // 3. Update the Chart
                    const newData = [
                        Math.max(1, Math.min(10, newState.meaning)),
                        Math.max(1, Math.min(10, newState.vitality)),
                        Math.max(1, Math.min(10, newState.cognition)),
                        Math.max(1, Math.min(10, newState.emotion)),
                        Math.max(1, Math.min(10, newState.adaptability))
                    ];
                    
                    systemChart.data.datasets[0].data = newData;
                    systemChart.data.datasets[1].data = newData;
                    systemChart.data.datasets[1].hidden = true; // Hide projected state after event simulation
                    systemChart.update();

                } catch (error) {
                    aiEntry.innerHTML = `<p class="font-semibold text-red-500">Simulation Error</p><p>Could not contact the AI simulation network. (Details: ${escapeHTML(error.message)})</p>`;
                } finally {
                    runAiCycleBtn.disabled = false;
                    cycleLoader.classList.add('hidden');
                    cycleBtnText.textContent = 'ðŸ§  Simulate Event';
                    eventInput.value = ''; // Clear input after simulation
                    updateSectionVisibility();
                    simulationLogContainer.scrollTop = simulationLogContainer.scrollHeight;
                }
            });

            runRecommendationBtn.addEventListener('click', async () => {
                temporarilyShowSections();
                window.scrollTo({ top: 0, behavior: 'smooth' });

                runRecommendationBtn.disabled = true;
                recommendationLoader.classList.remove('hidden');
                recommendationBtnText.textContent = 'Analyzing...';
                initialLog.classList.add('hidden');

                const aiEntry = document.createElement('div');
                aiEntry.className = 'p-3 bg-[#2a1b3d] rounded-lg border-l-4 border-[#9B5DE0]';
                aiEntry.innerHTML = `<p class="font-semibold text-[#9B5DE0] mb-2">System Recommendation:</p><div class="space-y-1 text-sm text-gray-400 italic">Analyzing current state for optimization...</div>`;
                logEntries.appendChild(aiEntry);

                simulationLogContainer.scrollTop = simulationLogContainer.scrollHeight;
                
                const currentData = systemChart.data.datasets[0].data;
                const currentState = {
                    meaning: currentData[0],
                    vitality: currentData[1],
                    cognition: currentData[2],
                    emotion: currentData[3],
                    adaptability: currentData[4]
                };
                
                const payload = { currentState, type: 'recommend' };

                try {
                    const result = await callApi(RECOMMEND_ENDPOINT, payload);
                    const { recommendation, newState } = result;

                    let recommendationHtml = `<p class="font-semibold text-[#9B5DE0] mb-2">System Recommendation:</p><p class="text-gray-300 mb-4">${escapeHTML(recommendation)}</p><p class="text-xs italic text-[#F15BB5]">Chart shows projected state if this recommendation is implemented.</p>`;
                    aiEntry.innerHTML = recommendationHtml;
                    
                    const newData = [
                        Math.max(1, Math.min(10, newState.meaning)),
                        Math.max(1, Math.min(10, newState.vitality)),
                        Math.max(1, Math.min(10, newState.cognition)),
                        Math.max(1, Math.min(10, newState.emotion)),
                        Math.max(1, Math.min(10, newState.adaptability))
                    ];
                    
                    // Update Projected State Dataset
                    systemChart.data.datasets[1].data = newData;
                    systemChart.data.datasets[1].hidden = false;
                    systemChart.update();

                } catch (error) {
                    aiEntry.innerHTML = `<p class="font-semibold text-red-500">Recommendation Error</p><p>Could not contact the AI simulation network. (Details: ${escapeHTML(error.message)})</p>`;
                } finally {
                    runRecommendationBtn.disabled = false;
                    recommendationLoader.classList.add('hidden');
                    recommendationBtnText.textContent = 'ðŸ’¡ Get Recommendation';
                    updateSectionVisibility();
                    simulationLogContainer.scrollTop = simulationLogContainer.scrollHeight;
                }
            });

        });
    </script>
</body>
</html>